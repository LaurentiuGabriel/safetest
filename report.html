<!DOCTYPE html>

<!-- report.html#results=https://safetest-two.vercel.app/cra/artifacts/results.json&artifacts=https://safetest-two.vercel.app/cra/artifacts/artifacts-info.json -->

<!-- python3 -m http.server 9000 -  -->
<!-- http://localhost:9000/report.html#results=%2Fexamples%2Fcra%2Fresults.json&base=https://safetest-two.vercel.app/cra/ -->
<!-- http://localhost:9000/report.html#results=%2Fexamples%2Fvite-react-ts%2Fresults.json&base=https://safetest-two.vercel.app/vite-react-ts/ -->

<!-- https://safetest-two.vercel.app/report.html#results=cra%2Fartifacts%2Fresults.json&base=https%3A%2F%2Fsafetest-two.vercel.app%2Fcra%2F -->

<html lang="en">
  <title>htm Demo</title>
  <meta charset="UTF-8" />
  <style>
    details {
      padding-left: 8px;
    }
  </style>
  <script type="module">
    import { render } from 'https://esm.sh/preact';
    import * as Preact from 'https://esm.sh/preact/hooks';
    import { html } from 'https://esm.sh/htm/preact';

    const hash = new URLSearchParams(location.hash.slice(1));
    const useHashState = (name, defaultValue) => {
      const [state, setState] = Preact.useState(() => {
        let value = defaultValue;
        if (hash.has(name)) {
          value = hash.get(name);
        }
        return value;
      });
      const setWrapped = (value) => {
        const nextValue = typeof value === 'function' ? value(state) : value;
        setState(nextValue);
        if (nextValue === defaultValue) hash.delete(name);
        else hash.set(name, nextValue);
        location.hash = new URLSearchParams(hash);
      };
      return [state, setWrapped];
    };

    const useFetching = (url, { enabled = true } = {}) => {
      const [loading, setLoading] = Preact.useState(false);
      const [data, setData] = Preact.useState();
      const [error, setError] = Preact.useState();
      const fetcher = Preact.useCallback(async () => {
        if (!enabled) return;
        setLoading(true);
        fetch(url)
          .then((r) => r.json())
          .then(setData, setError)
          .finally(() => setLoading(false));
      }, [url, enabled]);
      Preact.useEffect(fetcher, [url]);
      return { loading, data, error };
    };

    const absolute = (relative) => {
      const link = document.createElement('a');
      link.href = relative;
      return link.href;
    };

    const App = () => {
      const [resultsLocation, setResults] = useHashState('results');
      const [base] = useHashState('base', '');
      const resultsJson = useFetching(resultsLocation, {
        enabled: !!resultsLocation,
      });

      window.resultsJson = resultsJson;

      const results = resultsJson.data;

      // const strapped = artifactsJson.data?.bootstrappedAt;
      // const base = '';
      const flattenResults = resultsJson.data?.testResults?.flatMap((result) =>
        result.assertionResults.flatMap((s) => ({
          filename: result.name,
          ...s,
        }))
      );

      let root = null;
      if (results) {
        const tests = {};
        for (const result of results.testResults) {
          const filename = result.name;
          for (const assertionResult of result.assertionResults) {
            let test = (tests[filename] ??= {});
            for (const ancestorTitles of assertionResult.ancestorTitles) {
              test[ancestorTitles] ??= {};
              test = test[ancestorTitles];
            }
            test[assertionResult.title] = assertionResult.fullName.trim();
          }
        }

        const artifactsEntries = Object.entries(results?.artifacts ?? {});
        const hasFilename = artifactsEntries.some((entry) =>
          Object.keys(entry[1] ?? {})[0]?.includes(entry[0])
        );

        root = recur(tests);
        function recur(map, filename = '', title = '') {
          const item = {};
          const children = [];

          const tag = !title.length ? 'div' : 'details';
          const element = html`<${tag} open><summary>${title}</summary>${children}</${tag}>`;
          if (title) item.filename = title;
          for (const [key, value] of Object.entries(map)) {
            if (typeof value === 'string') {
              const fullName = value;

              const result = flattenResults.find(
                (f) =>
                  f.filename === filename &&
                  f.fullName.trim() === fullName.trim()
              );

              if (!item.tests) item.tests = [];
              item.tests.push(result);
              const icons = {
                passed: '✅',
                failed: '❌',
                focused: '🔍',
                skipped: '⏭️',
                pending: '⏳',
                todo: '📝',
                disabled: '🚫',
              };
              const artifacts = result.artifacts ?? {};

              children.push(
                html`<details>
                  <summary>${result.fullName} ${icons[result.status]}</summary>
                  <div style="display: flex; gap: 12px">
                    ${artifacts['video']?.map(
                      (a) =>
                        html`<details style="display: inline-flex">
                          <summary>Video</summary>
                          <video
                            style="border: 1px solid"
                            src="${base}${a}"
                            controls
                          ></video>
                        </details>`
                    )}
                    ${artifacts['snapshot']?.map(
                      (a) =>
                        html`<details style="display: inline-flex">
                          <summary>Snapshot</summary>
                          <img
                            style="border: 1px solid"
                            src="${base}artifacts/${a}"
                          />
                        </details>`
                    )}
                    ${artifacts['trace']?.map(
                      (a) =>
                        html`<a target="_blank" href="${base}artifacts/trace/index.html?trace=${absolute(
                          `${base}${a}`
                        )}">Trace</a`
                    )}
                  </div>
                </details>`
              );
            } else {
              children.push(recur(value, filename || key, filename ? '' : key));
            }
          }
          return element;
        }
      }

      return html`
        <div>
          <div style="display: flex">
            ${!resultsLocation &&
            html`
              <label
                style="display: flex; flex-grow: 1; align-items: center; padding: 8px"
              >
                Results
                <input
                  style="flex-grow: 1; margin: 0 8px"
                  type="text"
                  value=${resultsLocation}
                  onKeydown=${(e) => {
                    if (e.key === 'Enter') {
                      setResults(e.target.value);
                    }
                  }}
                />
              </label>
            `}
          </div>
          <div>${root}</div>
        </div>
      `;
    };

    render(html`<${App} />`, document.body);
  </script>
</html>
