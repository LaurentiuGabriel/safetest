<!DOCTYPE html>
<html lang="en">
  <title>htm Demo</title>
  <style>
    details {
      padding-left: 8px;
    }
  </style>
  <script type="module">
    import { render } from 'https://esm.sh/preact';
    import * as Preact from 'https://esm.sh/preact/hooks';
    import { html } from 'https://esm.sh/htm/preact';

    const hash = new URLSearchParams(location.hash.slice(1));
    const useHashState = (name, defaultValue) => {
      const [state, setState] = Preact.useState(() => {
        let value = defaultValue;
        if (hash.has(name)) {
          value = hash.get(name);
          try {
            value = JSON.parse(value);
          } catch {}
        }
        return value;
      });
      const setWrapped = (value) => {
        const nextValue = typeof value === 'function' ? value(state) : value;
        setState(nextValue);
        if (nextValue === defaultValue) hash.delete(name);
        else hash.set(name, JSON.stringify(nextValue));
        location.hash = new URLSearchParams(hash);
      };
      return [state, setWrapped];
    };

    const useFetching = (url, { enabled = true } = {}) => {
      const [loading, setLoading] = Preact.useState(false);
      const [data, setData] = Preact.useState();
      const [error, setError] = Preact.useState();
      const fetcher = Preact.useCallback(async () => {
        if (!enabled) return;
        setLoading(true);
        fetch(url)
          .then((r) => r.json())
          .then(setData, setError)
          .finally(() => setLoading(false));
      }, [url, enabled]);
      Preact.useEffect(fetcher, [url]);
      return { loading, data, error };
    };

    const App = () => {
      const [count, setCount] = useHashState('count', 0);

      const [resultsLocation, setResults] = useHashState('results');
      const resultsJson = useFetching(resultsLocation, {
        enabled: !!resultsLocation,
      });

      const [artifacts, setArtifacts] = useHashState('artifacts');
      const artifactsJson = useFetching(artifacts, { enabled: !!artifacts });

      window.resultsJson = resultsJson;
      window.artifactsJson = artifactsJson;

      if (artifactsJson.data) {
        artifactsJson.data.bootstrappedAt =
          '/home/runner/work/safetest/safetest/examples/cra/src/index.js';
      }

      const results = resultsJson.data;

      const strapped = artifactsJson.data?.bootstrappedAt;
      const base = strapped ? strapped.slice(0, strapped.lastIndexOf('/')) : '';
      const flattenResults = resultsJson.data?.testResults?.flatMap((result) =>
        result.assertionResults.flatMap((s) => ({
          filename: result.name.slice(base.length + 1),
          ...s,
        }))
      );

      let root = null;
      if (results) {
        const tests = {};
        for (const result of results.testResults) {
          const filename = result.name.slice(base.length + 1);
          for (const assertionResult of result.assertionResults) {
            let test = (tests[filename] ??= {});
            for (const ancestorTitles of assertionResult.ancestorTitles) {
              test[ancestorTitles] ??= {};
              test = test[ancestorTitles];
            }
            test[assertionResult.title] = assertionResult.fullName.trim();
          }
        }

        root = recur(tests);
        function recur(map, filename = '', title = '') {
          const item = {};
          const children = [];

          const tag = !title.length ? 'div' : 'details';
          const element = html`<${tag} open><summary>${title}</summary>${children}</${tag}>`;
          if (title) item.filename = title;
          for (const [key, value] of Object.entries(map)) {
            if (typeof value === 'string') {
              const fullName = value;

              const result = flattenResults.find(
                (f) => f.filename === filename && f.fullName === fullName
              );
              const artifacts = artifactsJson.data?.[filename][fullName];

              if (!item.tests) item.tests = [];
              item.tests.push({ result, artifacts });
              const icons = {
                passed: '‚úÖ',
                failed: '‚ùå',
                focused: 'üîç',
                skipped: '‚è≠Ô∏è',
                pending: '‚è≥',
                todo: 'üìù',
                disabled: 'üö´',
              };
              const byType = {};
              if (artifacts) {
                for (const artifact of artifacts) {
                  byType[artifact.type] = byType[artifact.type] || [];
                  byType[artifact.type].push(artifact);
                }
              }
              children.push(
                html`<details>
                  <summary>${result.fullName} ${icons[result.status]}</summary>
                  ${byType['video']?.map(
                    (a) =>
                      html`<details style="display: inline-block">
                        <summary>Video</summary>
                        <video
                          src="https://safetest-two.vercel.app/cra/${a.path}"
                          controls
                        ></video>
                      </details>`
                  )}
                  ${byType['snapshot']?.map(
                    (a) =>
                      html`<details style="display: inline-block">
                        <summary>Snapshot</summary>
                        <img
                          src="https://safetest-two.vercel.app/cra/artifacts/${a.path}"
                        />
                      </details>`
                  )}
                  ${byType['trace']?.map(
                    (a) =>
                      html`<a target="_blank" href="https://safetest-two.vercel.app/cra/artifacts/trace/index.html?trace=https://safetest-two.vercel.app/cra/${a.path}">Trace</a`
                  )}
                </details>`
              );
            } else {
              children.push(recur(value, filename || key, filename ? '' : key));
            }
          }
          return element;
        }
      }

      return html`
        <div>
          <div>${root}</div>
        </div>
      `;
    };

    render(html`<${App} />`, document.body);
  </script>
</html>
