<!DOCTYPE html>
<html lang="en">
  <title>htm Demo</title>
  <meta charset="UTF-8" />
  <style>
    details {
      padding-left: 8px;
    }
  </style>
  <script type="module">
    import { render } from 'https://esm.sh/preact';
    import * as Preact from 'https://esm.sh/preact/hooks';
    import { html } from 'https://esm.sh/htm/preact';

    const hash = new URLSearchParams(location.hash.slice(1));
    const useHashState = (name, defaultValue) => {
      const [state, setState] = Preact.useState(() => {
        let value = defaultValue;
        if (hash.has(name)) {
          value = hash.get(name);
        }
        return value;
      });
      const setWrapped = (value) => {
        const nextValue = typeof value === 'function' ? value(state) : value;
        setState(nextValue);
        if (nextValue === defaultValue) hash.delete(name);
        else hash.set(name, nextValue);
        location.hash = new URLSearchParams(hash);
      };
      return [state, setWrapped];
    };

    const useFetching = (url, { enabled = true } = {}) => {
      const [loading, setLoading] = Preact.useState(false);
      const [data, setData] = Preact.useState();
      const [error, setError] = Preact.useState();
      const fetcher = Preact.useCallback(async () => {
        if (!enabled) return;
        setLoading(true);
        fetch(url)
          .then((r) => r.json())
          .then(setData, setError)
          .finally(() => setLoading(false));
      }, [url, enabled]);
      Preact.useEffect(fetcher, [url]);
      return { loading, data, error };
    };

    const App = () => {
      const [resultsLocation, setResults] = useHashState('results');
      const [base] = useHashState('base', '');
      const resultsJson = useFetching(resultsLocation, {
        enabled: !!resultsLocation,
      });

      window.resultsJson = resultsJson;

      const results = resultsJson.data;

      // const strapped = artifactsJson.data?.bootstrappedAt;
      // const base = '';
      const flattenResults = resultsJson.data?.testResults?.flatMap((result) =>
        result.assertionResults.flatMap((s) => ({
          filename: result.name.slice(base.length + 1),
          ...s,
        }))
      );

      let root = null;
      if (results) {
        const tests = {};
        for (const result of results.testResults) {
          const filename = result.name.slice(base.length + 1);
          for (const assertionResult of result.assertionResults) {
            let test = (tests[filename] ??= {});
            for (const ancestorTitles of assertionResult.ancestorTitles) {
              test[ancestorTitles] ??= {};
              test = test[ancestorTitles];
            }
            test[assertionResult.title] = assertionResult.fullName.trim();
          }
        }

        const artifactsEntries = Object.entries(resultsJson.data.artifacts);
        const hasFilename = Object.keys(
          artifactsEntries[0]?.[1] ?? {}
        )[0]?.includes(artifactsEntries[0][0]);

        root = recur(tests);
        function recur(map, filename = '', title = '') {
          const item = {};
          const children = [];

          const tag = !title.length ? 'div' : 'details';
          const element = html`<${tag} open><summary>${title}</summary>${children}</${tag}>`;
          if (title) item.filename = title;
          for (const [key, value] of Object.entries(map)) {
            if (typeof value === 'string') {
              const fullName = value;

              const result = flattenResults.find(
                (f) =>
                  f.filename === filename &&
                  f.fullName.trim() === fullName.trim()
              );

              const fileEntries = artifactsEntries.find((e) =>
                filename.endsWith(e[0])
              );

              const cleanedArtifacts = Object.fromEntries(
                Object.entries(fileEntries[1]).map(([k, v]) => [
                  hasFilename ? k.split(' > ').slice(1).join(' ').trim() : k,
                  v,
                ])
              );

              const artifacts = cleanedArtifacts[fullName];

              // const artifacts = artifactsEntries.find((e) =>
              //   filename.endsWith(e[0])
              // )?.[1]?.[result.fullName];

              console.log({ cleanedArtifacts, artifacts });

              if (!item.tests) item.tests = [];
              item.tests.push({ result, artifacts });
              const icons = {
                passed: '‚úÖ',
                failed: '‚ùå',
                focused: 'üîç',
                skipped: '‚è≠Ô∏è',
                pending: '‚è≥',
                todo: 'üìù',
                disabled: 'üö´',
              };
              const byType = {};
              if (artifacts) {
                for (const artifact of artifacts) {
                  byType[artifact.type] = byType[artifact.type] || [];
                  byType[artifact.type].push(artifact);
                }
              }
              children.push(
                html`<details>
                  <summary>${result.fullName} ${icons[result.status]}</summary>
                  <div style="display: flex; gap: 12px">
                    ${byType['video']?.map(
                      (a) =>
                        html`<details style="display: inline-flex">
                          <summary>Video</summary>
                          <video
                            style="border: 1px solid"
                            src="${base}${a.path}"
                            controls
                          ></video>
                        </details>`
                    )}
                    ${byType['snapshot']?.map(
                      (a) =>
                        html`<details style="display: inline-flex">
                          <summary>Snapshot</summary>
                          <img
                            style="border: 1px solid"
                            src="${base}artifacts/${a.path}"
                          />
                        </details>`
                    )}
                    ${byType['trace']?.map(
                      (a) =>
                        html`<a target="_blank" href="${base}artifacts/trace/index.html?trace=${base}${a.path}">Trace</a`
                    )}
                  </div>
                </details>`
              );
            } else {
              children.push(recur(value, filename || key, filename ? '' : key));
            }
          }
          return element;
        }
      }

      return html`
        <div>
          <div style="display: flex">
            <label
              style="display: flex; flex-grow: 1; align-items: center; padding: 8px"
            >
              Results
              <input
                style="flex-grow: 1; margin: 0 8px"
                type="text"
                value=${resultsLocation}
                onInput=${(e) => setResults(e.target.value)}
              />
            </label>
            <label
              style="display: flex; flex-grow: 1; align-items: center; padding: 8px"
            >
              Artifacts
              <input
                style="flex-grow: 1; margin: 0 8px"
                type="text"
                value=${''}
                onInput=${(e) => setArtifacts(e.target.value)}
              />
            </label>
          </div>
          <div>${root}</div>
        </div>
      `;
    };

    render(html`<${App} />`, document.body);
  </script>
</html>
